<!doctype html>
<html lang="sk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b1220" />
  <title>Upratovací plánovač BD 642</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- Ikony (GitHub Pages friendly – relatívne cesty) -->
  <link rel="icon" href="./icon-192.png" />
  <link rel="apple-touch-icon" href="./icon-192.png" />

  <style>
    :root{
      --bg:#0b1220;
      --card:#0f1a2e;
      --text:#e6eefc;
      --muted:#9fb0d0;
      --line:rgba(255,255,255,.10);
      --shadow:0 12px 30px rgba(0,0,0,.35);

      --pri:#22d3ee;
      --pri2:#60a5fa;
      --ok:#34d399;
      --warn:#fbbf24;
      --bad:#fb7185;

      --hlBg:rgba(34,211,238,.12);
      --hlLine:#22d3ee;
      --hlText:#7dd3fc;

      --r:16px;

      --fieldBg: rgba(15,26,46,.92);
      --fieldLine: rgba(255,255,255,.18);

      --modalBg: #0b1730;
      --modalLine: rgba(255,255,255,.18);

      --pad: 14px;
      --tap: 44px;
      --fs-1: 12px;
      --fs-2: 13px;
      --fs-3: 15px;
      --fs-4: 16px;
      --fs-5: 18px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(34,211,238,.10), transparent 55%),
        radial-gradient(1000px 700px at 90% 30%, rgba(96,165,250,.12), transparent 55%),
        var(--bg);
      color:var(--text);
      color-scheme: dark;
      -webkit-text-size-adjust:100%;
      text-rendering:optimizeLegibility;
    }
    a{color:inherit}
    .app{max-width:1180px;margin:0 auto;padding:var(--pad);padding-bottom:calc(var(--pad) + env(safe-area-inset-bottom))}
    header{
      background:linear-gradient(135deg, rgba(34,211,238,.22), rgba(96,165,250,.18));
      border:1px solid var(--line);
      color:var(--text);border-radius:18px;padding:14px 14px 12px;box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
    }

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .spacer{flex:1}
    .muted{color:var(--muted);font-size:var(--fs-1);line-height:1.5;margin:0}

    .brand{display:flex;align-items:center;gap:10px;min-width:260px}
    .brand .logo{
      width:38px;height:38px;border-radius:12px;background:rgba(255,255,255,.08);
      border:1px solid var(--line);
      display:grid;place-items:center;flex:0 0 auto
    }
    .brand h1{font-size:var(--fs-4);margin:0;line-height:1.2}
    .brand .sub{display:none !important;}

    .top{display:flex;gap:12px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap}
    .status{
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;font-size:var(--fs-1);
      max-width:100%;
    }
    .pill{
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      padding:6px 10px;border-radius:999px;display:flex;gap:8px;align-items:center;
      max-width:100%;
    }
    .dot{width:8px;height:8px;border-radius:999px;background:#fff;opacity:.9}
    .dot.ok{background:var(--ok)}
    .dot.off{background:var(--bad)}
    .dot.sync{background:var(--warn)}

    .tabs{margin-top:12px;display:flex;gap:8px;flex-wrap:wrap}
    .tabbtn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;border-radius:999px;font-weight:800;
      cursor:pointer;display:flex;gap:8px;align-items:center;font-size:var(--fs-2);
      min-height:var(--tap);
      -webkit-tap-highlight-color: transparent;
    }
    .tabbtn[aria-selected="true"]{background:rgba(34,211,238,.16);border-color:rgba(34,211,238,.35)}

    main{margin-top:14px;display:grid;gap:12px}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--line);border-radius:var(--r);
      box-shadow:0 1px 0 rgba(0,0,0,.3);
      padding:14px;
      overflow:hidden;
    }
    .card h2{margin:0 0 8px;font-size:var(--fs-4)}
    .btn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.05);
      color:var(--text);
      padding:10px 12px;border-radius:12px;font-weight:800;cursor:pointer;font-size:var(--fs-2);
      min-height:var(--tap);
      -webkit-tap-highlight-color: transparent;
    }
    .btn.pri{background:linear-gradient(135deg, rgba(34,211,238,.85), rgba(96,165,250,.75));border-color:rgba(34,211,238,.35);color:#07101c}
    .btn:disabled{opacity:.45;cursor:not-allowed}
    .mini{font-size:var(--fs-2);padding:8px 10px;border-radius:10px;min-height:40px}
    .tag{
      display:inline-flex;gap:8px;align-items:center;
      border:1px solid var(--line);padding:6px 10px;border-radius:999px;
      font-size:var(--fs-1);color:var(--muted);
      background:rgba(255,255,255,.04)
    }
    .tag.ok{border-color:rgba(52,211,153,.35);background:rgba(52,211,153,.10);color:#bbf7d0}
    .tag.bad{border-color:rgba(251,113,133,.35);background:rgba(251,113,133,.10);color:#fecdd3}
    .tag.warn{border-color:rgba(251,191,36,.35);background:rgba(251,191,36,.10);color:#fde68a}

    input,select,textarea{
      width:100%;
      padding:12px 12px;
      border:1px solid var(--fieldLine);
      border-radius:12px;
      font:inherit;
      background:var(--fieldBg);
      color:var(--text);
      outline:none;
      font-size:16px;
    }
    textarea{min-height:110px;resize:vertical}
    input::placeholder, textarea::placeholder{ color: rgba(159,176,208,.75); }
    input:focus,select:focus,textarea:focus{
      border-color: rgba(34,211,238,.45);
      box-shadow: 0 0 0 3px rgba(34,211,238,.12);
    }
    select, option{ background-color: var(--modalBg); color: var(--text); }

    .tablewrap{overflow:auto;border:1px solid var(--line);border-radius:12px}
    table{width:100%;border-collapse:collapse;min-width:1020px;background:transparent}
    th,td{padding:10px 12px;border-bottom:1px solid var(--line);text-align:left;font-size:var(--fs-2);vertical-align:top}
    th{font-size:var(--fs-1);color:var(--muted);background:rgba(255,255,255,.03)}
    tr:last-child td{border-bottom:none}
    tr.current td{background:var(--hlBg)}
    tr.current td:first-child{box-shadow:inset 4px 0 0 var(--hlLine)}
    .badgeNow{
      display:inline-flex;gap:6px;align-items:center;
      font-size:var(--fs-1);font-weight:900;color:var(--hlText);
      border:1px solid rgba(34,211,238,.30);background:rgba(255,255,255,.04);border-radius:999px;
      padding:4px 8px;margin-left:10px
    }

    .mobileSchedule{display:none;margin-top:12px;gap:10px}
    .wcard{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      background:rgba(15,26,46,.55);
    }
    .whead{display:flex;gap:10px;align-items:flex-start;justify-content:space-between}
    .wleft{min-width:0}
    .wweek{font-weight:900;font-size:var(--fs-3);line-height:1.2}
    .wfam{margin-top:6px;font-weight:800}
    .wnote{margin-top:8px;color:var(--muted);font-size:var(--fs-1);line-height:1.45}
    .wactions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}

    .kpi{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    @media(min-width:700px){ .kpi{grid-template-columns:repeat(4,1fr)} }
    .k{background:rgba(255,255,255,.04);border:1px solid var(--line);border-radius:12px;padding:10px;min-width:0}
    .k .v{font-size:var(--fs-5);font-weight:900;word-break:break-word}
    .k .l{font-size:var(--fs-1);color:var(--muted)}

    .overlay{
      position:fixed;inset:0;z-index:80;
      display:flex;align-items:center;justify-content:center;
      background:rgba(0,0,0,.82);
      backdrop-filter: blur(6px);
      padding:16px;
    }
    .loginCard{
      width:min(520px,100%);
      background:var(--modalBg);
      border:1px solid var(--modalLine);
      border-radius:18px;
      box-shadow:0 20px 60px rgba(0,0,0,.65);
      padding:14px;
    }
    .loginCard h2{margin:0 0 6px;font-size:var(--fs-4)}
    .loginGrid{display:grid;gap:10px;margin-top:10px}
    .divider{height:1px;background:var(--line);margin:12px 0}
    .small{font-size:var(--fs-1);color:var(--muted);line-height:1.45}
    .hidden{display:none !important}
    .err{margin-top:8px;display:none}
    .err.show{display:flex}

    .chatBox{
      border:1px solid var(--fieldLine);
      border-radius:12px;
      background:rgba(15,26,46,.55);
      max-height:320px;
      overflow:auto;
      padding:10px;
      overscroll-behavior:contain;
    }

    /* Reminders modal */
    .remCard{
      width:min(760px,100%);
      background:var(--modalBg);
      border:1px solid var(--modalLine);
      border-radius:18px;
      box-shadow:0 20px 60px rgba(0,0,0,.65);
      padding:14px;
    }
    .remList{
      margin-top:10px;
      border:1px solid var(--fieldLine);
      border-radius:12px;
      background:rgba(15,26,46,.55);
      padding:10px;
      max-height:260px;
      overflow:auto;
    }
    .remItem{
      display:flex;gap:10px;align-items:center;justify-content:space-between;
      padding:8px 10px;border:1px solid var(--line);border-radius:12px;
      margin:0 0 8px;background:rgba(0,0,0,.10)
    }
    .remItem:last-child{margin-bottom:0}
    .remWhen{font-size:13px}
    .remWhen small{display:block;color:var(--muted);font-size:11px;margin-top:2px}

    /* recurring presets UI */
    .presetCard{
      margin-top:12px;
      border:1px solid var(--fieldLine);
      border-radius:12px;
      background:rgba(15,26,46,.35);
      padding:10px;
    }
    .grid2{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:720px){ .grid2{grid-template-columns:1fr 1fr} }

    @media (max-width: 720px){
      :root{ --pad: 12px; }
      header{padding:12px}
      .brand{min-width:0;flex:1}
      .status{gap:8px}
      #txtLast{display:none;}
      .pill{padding:6px 9px}
      .tabbtn{flex:1;justify-content:center}
      .mini{min-height:44px}
      .tablewrap{display:none}
      .mobileSchedule{display:grid}
      .kpi{grid-template-columns:repeat(2,1fr)}
      .row{gap:8px}
      .wactions .btn{flex:1}
    }
    @media (max-width: 420px){
      .brand h1{font-size:15px}
      .tabbtn{font-size:12px;padding:9px 10px}
      .badgeNow{margin-left:6px}
    }
  </style>

  <!-- PWA -->
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Upratovací plánovač BD 642">
</head>

<body>
  <!-- LOGIN OVERLAY -->
  <div class="overlay" id="loginOverlay" aria-hidden="false">
    <div class="loginCard">
      <div class="row">
        <div class="brand" style="min-width:0">
          <div class="logo"><i class="fa-solid fa-broom"></i></div>
          <div style="min-width:0">
            <h2>Prihlásenie</h2>
            <div class="small">
              Zadaj priezvisko alebo rodinu. Nezáleží na veľkosti písmen ani diakritike.
            </div>
          </div>
        </div>
      </div>

      <div class="loginGrid">
        <div>
          <label style="font-size:12px;color:var(--muted);display:block;margin:0 0 6px">Kód</label>
          <input id="loginCode" placeholder="Zadaj priezvisko alebo rodinu" autocomplete="off" inputmode="text" />
          <div class="tag bad err" id="loginErr"><i class="fa-solid fa-triangle-exclamation"></i><span id="loginErrTxt">Neplatný kód.</span></div>

          <div class="divider"></div>

          <div class="row">
            <button class="btn pri" id="loginBtn"><i class="fa-solid fa-right-to-bracket"></i> Prihlásiť</button>
            <span class="spacer"></span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- REMINDERS OVERLAY -->
  <div class="overlay hidden" id="remOverlay" aria-hidden="true">
    <div class="remCard">
      <div class="row">
        <div style="min-width:0">
          <h2 style="margin:0">Upozornenia</h2>
          <div class="small" id="remTitle">—</div>
          <div class="small" style="margin-top:6px">
            Lokálne notifikácie fungujú spoľahlivo, keď je stránka (alebo PWA) otvorená. Pre push notifikácie použi tlačidlo <strong>Zapnúť push</strong> v Nastaveniach (podporované len v niektorých prehliadačoch, napr. Chrome na Androide).
          </div>
        </div>
        <span class="spacer"></span>
        <button class="btn mini" id="remClose"><i class="fa-solid fa-xmark"></i></button>
      </div>

      <div class="divider"></div>

      <!-- ONE-OFF -->
      <div class="row">
        <div style="flex:1;min-width:240px">
          <label style="font-size:12px;color:var(--muted);display:block;margin:0 0 6px">Jednorazové upozornenie (dátum a čas)</label>
          <input type="datetime-local" id="remDt" />
          <div class="small" id="remHint" style="margin-top:6px">—</div>
        </div>
        <div style="flex:0 0 auto;align-self:end">
          <button class="btn pri" id="remAdd"><i class="fa-solid fa-plus"></i> Pridať</button>
        </div>
      </div>

      <!-- RECURRING PRESETS -->
      <div class="presetCard">
        <div class="row">
          <div style="min-width:0">
            <div style="font-weight:900">Trvalé nastavenie (na všetky moje týždne)</div>
            <div class="small">Vytvorí upozornenia pre všetky obdobia, keď budeš na rade. Nastavenie sa dá kedykoľvek zmazať.</div>
          </div>
        </div>

        <div class="grid2" style="margin-top:10px">
          <div>
            <label style="font-size:12px;color:var(--muted);display:block;margin:0 0 6px">Deň v týždni</label>
            <select id="presetDow">
              <option value="1">Pondelok</option>
              <option value="2">Utorok</option>
              <option value="3">Streda</option>
              <option value="4">Štvrtok</option>
              <option value="5">Piatok</option>
              <option value="6">Sobota</option>
              <option value="0">Nedeľa</option>
            </select>
          </div>

          <div>
            <label style="font-size:12px;color:var(--muted);display:block;margin:0 0 6px">Čas</label>
            <input type="time" id="presetTime" value="18:00" />
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn pri" id="presetApply"><i class="fa-solid fa-wand-magic-sparkles"></i> Použiť na všetky moje týždne</button>
          <button class="btn" id="presetClear" style="border-color:rgba(251,113,133,.35)"><i class="fa-solid fa-trash"></i> Zmazať trvalé nastavenie</button>
          <span class="spacer"></span>
          <span class="tag" id="presetState"><i class="fa-regular fa-bookmark"></i> Trvalé: —</span>
        </div>
      </div>

      <div class="remList" id="remList"></div>

      <div class="row" style="margin-top:10px">
        <span class="tag" id="remCount"><i class="fa-regular fa-bell"></i> 0 upozornení</span>
        <span class="spacer"></span>
        <button class="btn" id="remClear" title="Zmaže všetky upozornenia pre tento týždeň" style="border-color:rgba(251,113,133,.35)"><i class="fa-solid fa-trash"></i> Vymazať tento týždeň</button>
      </div>
    </div>
  </div>

  <div class="app">
    <header>
      <div class="top">
        <div class="brand">
          <div class="logo"><i class="fa-solid fa-broom"></i></div>
          <div style="min-width:0">
            <h1>Upratovací plánovač BD 642</h1>
            <div class="sub" id="subLine"></div>
          </div>
        </div>
        <div class="status">
          <div class="pill" id="pillFamily"><span class="dot ok"></span><span id="txtFamily">Prihlásený: —</span></div>
          <div class="pill" id="pillRole"><span class="dot sync"></span><span id="txtRole">Režim: Používateľ</span></div>
          <div class="pill"><span class="dot ok" id="dotOnline"></span><span id="txtOnline">Online</span></div>
          <div class="pill"><span class="dot sync" id="dotSync"></span><span id="txtSync">Sync: pripravené</span></div>
          <div class="pill"><i class="fa-regular fa-clock"></i><span id="txtLast">Posl. sync: —</span></div>
          <button class="btn mini" id="btnLogout" title="Odhlásiť"><i class="fa-solid fa-right-from-bracket"></i></button>
        </div>
      </div>

      <div class="tabs" role="tablist" aria-label="Navigácia">
        <button class="tabbtn" role="tab" aria-selected="true" data-tab="schedule"><i class="fa-regular fa-calendar"></i> Harmonogram</button>
        <button class="tabbtn" role="tab" aria-selected="false" data-tab="swaps"><i class="fa-solid fa-right-left"></i> Výmeny</button>
        <button class="tabbtn" role="tab" aria-selected="false" data-tab="chat"><i class="fa-regular fa-comments"></i> Chat</button>
        <button class="tabbtn" role="tab" aria-selected="false" data-tab="settings"><i class="fa-solid fa-gear"></i> Nastavenia</button>
      </div>
    </header>

    <main>
      <!-- Harmonogram -->
      <section class="card" id="tab-schedule">
        <div class="row">
          <div style="min-width:0">
            <h2>Harmonogram <span class="badgeNow" id="badgeNow" style="display:none"><i class="fa-solid fa-location-dot"></i> Aktuálny</span></h2>
          </div>
          <div class="spacer"></div>
          <button class="btn mini" id="btnMine"><i class="fa-solid fa-filter"></i> Len moje</button>
          <button class="btn mini" id="btnAll"><i class="fa-solid fa-list"></i> Všetky</button>
        </div>

        <div class="kpi" style="margin-top:10px">
          <div class="k"><div class="v" id="kpiNow">—</div><div class="l">Aktuálny týždeň</div></div>
          <div class="k"><div class="v" id="kpiFamily">—</div><div class="l">Kto upratuje</div></div>
          <div class="k"><div class="v" id="kpiSwaps">0</div><div class="l">Aktívne výmeny</div></div>
          <div class="k"><div class="v" id="kpiUnread">0</div><div class="l">Nové správy</div></div>
        </div>

        <!-- Desktop -->
        <div class="tablewrap" style="margin-top:12px">
          <table>
            <thead>
              <tr>
                <th>Týždeň (Po–Ne)</th>
                <th>Rodina / osoba</th>
                <th>Upozornenia</th>
                <th>Poznámka</th>
                <th>Akcia</th>
              </tr>
            </thead>
            <tbody id="scheduleBody"></tbody>
          </table>
        </div>

        <!-- Mobile -->
        <div class="mobileSchedule" id="scheduleMobile"></div>
      </section>

      <!-- Výmeny -->
      <section class="card hidden" id="tab-swaps">
        <h2>Výmeny termínov</h2>

        <div class="row" style="margin-top:10px">
          <span class="tag"><i class="fa-solid fa-user"></i> Prihlásený: <strong id="swapMe" style="margin-left:6px">—</strong></span>
        </div>

        <div style="margin-top:10px;display:grid;grid-template-columns:1fr;gap:10px">
          <div class="row">
            <div style="flex:1;min-width:220px">
              <label style="font-size:12px;color:var(--muted);display:block;margin:0 0 6px">Môj pôvodný týždeň</label>
              <select id="swapFrom"></select>
            </div>
            <div style="flex:1;min-width:220px">
              <label style="font-size:12px;color:var(--muted);display:block;margin:0 0 6px">Chcem vymeniť za</label>
              <select id="swapTo"></select>
            </div>
          </div>

          <div>
            <label style="font-size:12px;color:var(--muted);display:block;margin:0 0 6px">Správa (voliteľné)</label>
            <input id="swapMsg" placeholder="Napíš krátku správu" />
          </div>

          <div class="row">
            <button class="btn pri" id="swapCreate"><i class="fa-solid fa-paper-plane"></i> Odoslať žiadosť</button>
          </div>
        </div>

        <div class="tablewrap" style="margin-top:12px">
          <table>
            <thead>
              <tr>
                <th>Žiadateľ</th>
                <th>Z</th>
                <th>Na</th>
                <th>Stav</th>
                <th>Akcia</th>
              </tr>
            </thead>
            <tbody id="swapsBody"></tbody>
          </table>
        </div>
      </section>

      <!-- Chat -->
      <section class="card hidden" id="tab-chat">
        <div class="row">
          <div style="min-width:0">
            <h2>Chat</h2>
          </div>
          <div class="spacer"></div>
          <span class="tag"><i class="fa-solid fa-paperclip"></i> Prílohy</span>
        </div>

        <div class="card" style="margin-top:10px;padding:10px;background:rgba(15,26,46,.55);border-color:var(--fieldLine)">
          <div class="row" style="margin-bottom:8px">
            <span class="tag"><i class="fa-solid fa-user"></i> Píše: <strong id="chatMe" style="margin-left:6px">—</strong></span>
            <span class="spacer"></span>
            <button class="btn mini" id="chatMarkRead"><i class="fa-regular fa-circle-check"></i> Prečítané</button>
          </div>

          <div class="chatBox" id="msgs"></div>

          <div class="row" style="margin-top:10px">
            <input id="chatFile" type="file" style="flex:1;min-width:220px"/>
          </div>

          <div style="margin-top:10px">
            <textarea id="chatText" placeholder="Napíš správu…"></textarea>
          </div>

          <div class="row" style="margin-top:10px">
            <button class="btn pri" id="chatSend"><i class="fa-regular fa-paper-plane"></i> Odoslať</button>
          </div>
        </div>
      </section>

      <!-- Nastavenia -->
      <section class="card hidden" id="tab-settings">
        <div class="row">
          <div style="min-width:0">
            <h2>Nastavenia</h2>
          </div>
          <span class="spacer"></span>
          <span class="tag"><i class="fa-solid fa-user"></i> Prihlásený: <strong id="setMe" style="margin-left:6px">—</strong></span>
        </div>

        <div class="row" style="margin-top:10px">
          <div style="flex:1;min-width:220px">
            <label style="font-size:12px;color:var(--muted);display:block;margin:0 0 6px">Notifikácie (lokálne v prehliadači)</label>
            <select id="notifyEnabled">
              <option value="off" selected>Vypnuté</option>
              <option value="on">Zapnuté</option>
            </select>
          </div>

          <div style="flex:0 0 auto;align-self:end">
            <button class="btn pri" id="savePrefs"><i class="fa-regular fa-floppy-disk"></i> Uložiť</button>
          </div>
        </div>

        <!-- PUSH (Firebase Cloud Messaging) -->
        <div class="card" style="margin-top:12px;padding:12px;background:rgba(15,26,46,.55);border-color:var(--fieldLine)">
          <div class="row">
            <div style="min-width:0">
              <div style="font-weight:900">Push notifikácie (Firebase)</div>
            </div>
<div class="bd642-card" style="margin-top:12px;">
  <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
    <div>
      <div style="font-size:18px;font-weight:700;">Aplikácia (PWA)</div>
      <div id="bd642PwaInstallHint" style="opacity:.85;margin-top:6px;">
        Android/Windows: ak je web PWA-kompatibilný, tlačidlo sa aktivuje. iOS: iba Safari → Zdieľať → Pridať na plochu.
      </div>
    </div>
    <button id="bd642PwaInstallBtn" type="button" disabled style="min-width:160px;">
      ⬇️ Nainštalovať
    </button>
  </div>
  <div id="bd642PwaInstallState" style="margin-top:8px;opacity:.85;"></div>
</div>
            <span class="spacer"></span>
            <!-- žiadny inline onclick, všetko rieši JS nižšie -->
            <button class="btn pri" id="btnPushEnable" type="button">
              <i class="fa-solid fa-bell"></i> <span id="btnPushText">Zapnúť push</span>
            </button>
          </div>

          <div class="row" style="margin-top:10px">
            <span class="tag" id="pushState"><i class="fa-regular fa-bell"></i> Push: —</span>
            <span class="tag" id="pushTokenShort"><i class="fa-solid fa-key"></i> Token: —</span>
          </div>

          <div class="small" style="margin-top:8px">
            Pozn.: Prehliadač sa ťa najskôr musí opýtať na povolenie. Ak push nie je podporovaný alebo je zakázaný, zobrazí sa hlásenie a tlačidlo ostane neaktívne.
          </div>
        </div>
        <!-- /PUSH -->
        <!-- PWA INŠTALÁCIA -->
        <div class="card" id="pwaInstallCard" style="margin-top:12px;padding:12px;background:rgba(15,26,46,.55);border-color:var(--fieldLine)">
          <div class="row">
            <div style="min-width:0">
              <div style="font-weight:900">Aplikácia (PWA)</div>
              <div class="small" id="pwaInstallHint" style="margin-top:6px">—</div>
            </div>
            <span class="spacer"></span>
            <button class="btn pri" id="btnInstallApp" type="button" disabled>
              <i class="fa-solid fa-download"></i> <span id="btnInstallText">Nainštalovať</span>
            </button>
          </div>
          <div class="small" style="margin-top:10px">
            <strong>iOS (iPhone/iPad):</strong> v Safari otvor stránku → <em>Zdieľať</em> → <em>Pridať na plochu</em>.
          </div>
        </div>
        <!-- /PWA INŠTALÁCIA -->

        <div class="row" style="margin-top:10px">
          <span class="tag ok" id="prefsSaved"><i class="fa-regular fa-circle"></i> Neuložené</span>
          <span class="tag" id="notifyState"><i class="fa-regular fa-bell"></i> Notifikácie: —</span>
          <span class="tag" id="nextReminder"><i class="fa-regular fa-clock"></i> Najbližšie upozornenie: —</span>
          <span class="spacer"></span>
          <button class="btn mini" id="toggleOffline"><i class="fa-solid fa-wifi"></i> Online/Offline</button>
          <button class="btn mini" id="simulateSync"><i class="fa-solid fa-rotate"></i> Sync</button>
        </div>

        <div class="row" style="margin-top:10px">
          <div class="small" style="min-width:0">
            Kalendár harmonogramu si môžeš pridať do svojho Google/Outlook kalendára.
          </div>
          <span class="spacer"></span>
          <a href="./kalendar.ics" class="btn mini" id="btnIcs" download>
            <i class="fa-regular fa-calendar"></i> Stiahnuť kalendár (.ics)
          </a>
        </div>

        <div class="small" style="margin-top:10px">
          Upozornenia nastavíš v <strong>Harmonograme</strong> pri konkrétnom týždni. Trvalé nastavenie je v dialógu „Upozornenia“.
        </div>
      </section>
    </main>
  </div>

<script>
(function(){
  try {
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function () {
        navigator.serviceWorker.register('/firebase-messaging-sw.js', { scope: '/' })
          .then(function(){ /* ok */ })
          .catch(function(){ /* ignore */ });
      });
    }
  } catch(e){}
})();
</script>
<script>
/* BD642_PWA_INSTALL_UI */
(function(){
  "use strict";

  function isIOS(){
    return /iphone|ipad|ipod/i.test(navigator.userAgent) && !window.MSStream;
  }
  function isStandalone(){
    return (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) || (window.navigator && window.navigator.standalone);
  }

  // Nájde tlačidlo "Nainštalovať" v sekcii "Aplikácia (PWA)" podľa textu
  function findInstallButton(){
    var btns = Array.prototype.slice.call(document.querySelectorAll('button, a'));
    for(var i=0;i<btns.length;i++){
      var t = (btns[i].innerText || btns[i].textContent || "").trim();
      if(/nainštalovať/i.test(t)) return btns[i];
    }
    return null;
  }

  // Nájde sekciu lokálnych notifikácií podľa textu "Notifikácie (lokálne v prehliadači)" a tlačidlo "Uložiť"
  function findLocalNotifUI(){
    var candidates = Array.prototype.slice.call(document.querySelectorAll('*'));
    var headerEl = null;
    for(var i=0;i<candidates.length;i++){
      var txt = (candidates[i].innerText || candidates[i].textContent || "");
      if(txt && txt.indexOf("Notifikácie (lokálne v prehliadači)") !== -1){
        headerEl = candidates[i];
        break;
      }
    }
    if(!headerEl) return null;

    // hľadaj najbližší kontajner, kde je select + tlačidlo Uložiť
    var container = headerEl;
    for(var up=0; up<6 && container; up++){
      var sel = container.querySelector('select');
      var btns = Array.prototype.slice.call(container.querySelectorAll('button, a'));
      var saveBtn = null;
      for(var b=0;b<btns.length;b++){
        var bt = (btns[b].innerText || btns[b].textContent || "").trim();
        if(/^uložiť$/i.test(bt)) { saveBtn = btns[b]; break; }
      }
      if(sel && saveBtn) return { select: sel, saveBtn: saveBtn, container: container };
      container = container.parentElement;
    }
    return null;
  }

  // --- PWA install flow (Android/Windows) ---
  var deferredPrompt = null;
  var installBtn = null;

  function setInstallBtnState(state){
    if(!installBtn) return;
    if(state === "installed"){
      installBtn.disabled = true;
      installBtn.title = "Aplikácia je už nainštalovaná.";
      installBtn.style.opacity = "0.65";
      return;
    }
    if(state === "ready"){
      installBtn.disabled = false;
      installBtn.title = "";
      installBtn.style.opacity = "";
      return;
    }
    if(state === "ios"){
      installBtn.disabled = true;
      installBtn.title = "iOS: otvor v Safari → Zdieľať → Pridať na plochu.";
      installBtn.style.opacity = "0.65";
      return;
    }
    // default: not available yet
    installBtn.disabled = true;
    installBtn.title = "Inštalácia sa aktivuje, keď prehliadač vyhodnotí web ako inštalovateľný (HTTPS + manifest + service worker).";
    installBtn.style.opacity = "0.65";
  }

  window.addEventListener('beforeinstallprompt', function(e){
    // Chrome/Edge: zachyť prompt
    e.preventDefault();
    deferredPrompt = e;
    if(!installBtn) installBtn = findInstallButton();
    setInstallBtnState("ready");
  });

  window.addEventListener('appinstalled', function(){
    setInstallBtnState("installed");
    deferredPrompt = null;
  });

  function wireInstall(){
    installBtn = findInstallButton();
    if(!installBtn) return;

    if(isStandalone()){
      setInstallBtnState("installed");
      return;
    }
    if(isIOS()){
      setInstallBtnState("ios");
      return;
    }

    // kým nepríde beforeinstallprompt, drž disable
    setInstallBtnState("waiting");

    installBtn.addEventListener('click', async function(){
      try{
        if(!deferredPrompt){
          alert("Inštalácia zatiaľ nie je dostupná. Sprav tvrdý refresh (Ctrl+F5) a skontroluj, či bežíš na HTTPS.");
          return;
        }
        deferredPrompt.prompt();
        var choice = await deferredPrompt.userChoice;
        deferredPrompt = null;
        // ak odmietol, necháme disabled do ďalšieho eventu
        if(choice && choice.outcome === "accepted"){
          setInstallBtnState("installed");
        } else {
          setInstallBtnState("waiting");
        }
      } catch(err){
        console.error("BD642 PWA install chyba:", err);
        alert("Chyba pri inštalácii: " + (err && err.message ? err.message : err));
      }
    });
  }

  // --- Persistencia lokálnych notifikácií (Nastavenia) ---
  var LS_KEY = "bd642_local_notif_mode";

  function wireLocalNotifSave(){
    var ui = findLocalNotifUI();
    if(!ui) return;

    // load
    var saved = localStorage.getItem(LS_KEY);
    if(saved !== null && saved !== undefined && saved !== ""){
      // pokus nastaviť podľa value; ak nemá value, tak podľa textu (fallback)
      var hasValueMatch = false;
      for(var i=0;i<ui.select.options.length;i++){
        if(ui.select.options[i].value === saved){
          ui.select.value = saved;
          hasValueMatch = true;
          break;
        }
      }
      if(!hasValueMatch){
        // fallback: hľadaj option podľa textu
        for(var j=0;j<ui.select.options.length;j++){
          var ot = (ui.select.options[j].textContent || "").trim();
          if(ot.toLowerCase() === saved.toLowerCase()){
            ui.select.selectedIndex = j;
            break;
          }
        }
      }
    }

    ui.saveBtn.addEventListener('click', function(){
      try{
        var val = ui.select.value || "";
        if(!val){
          // fallback na text vybranej položky
          var opt = ui.select.options[ui.select.selectedIndex];
          val = opt ? (opt.value || opt.textContent || "") : "";
        }
        localStorage.setItem(LS_KEY, val);

        // ak existuje tvoja interná funkcia, zavolaj ju (nevadí, ak nie)
        if(typeof window.BD642_SetLocalNotifications === "function"){
          window.BD642_SetLocalNotifications(val);
        }
      } catch(err){
        console.error("BD642 local notif save chyba:", err);
        alert("Chyba pri ukladaní nastavenia: " + (err && err.message ? err.message : err));
      }
    });
  }

  // init po načítaní
  function init(){
    wireInstall();
    wireLocalNotifSave();
    // po navigácii v SPA sa UI môže meniť -> skúsiť znovu
    setTimeout(wireInstall, 500);
    setTimeout(wireLocalNotifSave, 500);
  }

  if(document.readyState === "complete" || document.readyState === "interactive"){
    setTimeout(init, 0);
  } else {
    document.addEventListener("DOMContentLoaded", init);
  }
})();
</script>

<script>
/* BD642_PWA_INSTALL_HANDLER */
(function(){
  let deferredPrompt = null;

  function el(id){ return document.getElementById(id); }
  function setState(txt){ const s=el('bd642PwaInstallState'); if(s) s.textContent = txt || ''; }

  function isIos(){
    return /iphone|ipad|ipod/i.test(navigator.userAgent);
  }

  function wirePwaInstall(){
    const btn = el('bd642PwaInstallBtn');
    if(!btn) return;

    // iOS – tlačidlo nechaj disabled, ale vysvetli postup
    if(isIos()){
      btn.disabled = true;
      setState('iOS: otvor v Safari → Zdieľať → Pridať na plochu.');
      return;
    }

    window.addEventListener('beforeinstallprompt', (e) => {
      // Chrome/Edge: zachyť prompt, aby sme vedeli spustiť z tlačidla
      e.preventDefault();
      deferredPrompt = e;
      btn.disabled = false;
      setState('Pripravené na inštaláciu.');
    });

    btn.addEventListener('click', async () => {
      try{
        if(!deferredPrompt){
          setState('Inštalácia nie je dostupná – skús menu prehliadača (Inštalovať aplikáciu) alebo vymaž cache.');
          return;
        }
        btn.disabled = true;
        deferredPrompt.prompt();
        const choice = await deferredPrompt.userChoice;
        deferredPrompt = null;
        setState(choice && choice.outcome === 'accepted' ? 'Inštalácia spustená.' : 'Inštalácia zrušená.');
      }catch(err){
        console.warn('BD642 install chyba:', err);
        setState('Chyba pri inštalácii – pozri konzolu.');
      }
    });

    window.addEventListener('appinstalled', () => {
      deferredPrompt = null;
      btn.disabled = true;
      setState('Aplikácia je nainštalovaná.');
    });
  }

  // Heuristika: perzistencia lokálnych notifikácií v Nastaveniach
  function wireLocalNotifPersistence(){
    try{
      const KEY = 'bd642_local_notif_setting';
      // nájdi select v sekcii Nastavení podľa textu
      const all = Array.from(document.querySelectorAll('select'));
      let target = null;

      for(const s of all){
        const wrap = s.closest('section,div') || s.parentElement;
        const txt = (wrap ? wrap.innerText : '') || '';
        if(txt.toLowerCase().includes('notifikácie') && txt.toLowerCase().includes('lokálne')){
          target = s; break;
        }
      }
      if(!target) return;

      // načítaj
      const saved = localStorage.getItem(KEY);
      if(saved !== null){
        target.value = saved;
      }

      // ukladaj pri zmene + pri kliknutí na tlačidlo "Uložiť"
      target.addEventListener('change', () => {
        localStorage.setItem(KEY, target.value);
      });

      const buttons = Array.from(document.querySelectorAll('button'));
      const saveBtn = buttons.find(b => (b.innerText || '').trim().toLowerCase() === 'uložiť');
      if(saveBtn){
        saveBtn.addEventListener('click', () => {
          localStorage.setItem(KEY, target.value);
        });
      }
    }catch(e){}
  }

  document.addEventListener('DOMContentLoaded', function(){
    wirePwaInstall();
    wireLocalNotifPersistence();
  });
})();
</script>
</body>
</html>
<script>
/* ===== BD642 AUTO SYNC ===== */
setInterval(() => {
  if(navigator.onLine && typeof BD642_Sync === "function"){
    console.debug("BD642 auto-sync");
    BD642_Sync();
  }
}, 300000); // 5 minút
</script>








