<!doctype html>
<html lang="sk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b1220" />
  <title>Upratovací Plánovač BD 642</title>
  <meta name="description" content="Rozpis upratovania BD 642 + lokálne pripomienky + (voliteľne) Push notifikácie cez Firebase." />

  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1a33;
      --panel2:#0c1630;
      --text:#e7eeff;
      --muted:#a7b7e6;
      --accent:#54d3ff;
      --accent2:#9b7bff;
      --good:#46f2a3;
      --warn:#ffd37a;
      --bad:#ff6b8b;
      --border:rgba(255,255,255,.10);
      --shadow:0 10px 30px rgba(0,0,0,.45);
      --radius:18px;
      --radius2:24px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      background:
        radial-gradient(1200px 600px at 12% 18%, rgba(84,211,255,.22), transparent 60%),
        radial-gradient(900px 700px at 88% 20%, rgba(155,123,255,.18), transparent 60%),
        radial-gradient(700px 800px at 70% 90%, rgba(70,242,163,.12), transparent 60%),
        var(--bg);
      color:var(--text);
      overflow-x:hidden;
    }
    a{color:inherit}
    .wrap{max-width:1200px;margin:0 auto;padding:18px 14px 34px}
    header{
      display:flex;gap:14px;align-items:center;justify-content:space-between;
      padding:16px 16px;border:1px solid var(--border);border-radius:var(--radius2);
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      box-shadow:var(--shadow);
      position:sticky;top:10px;z-index:50;
      backdrop-filter: blur(10px);
    }
    .brand{display:flex;gap:12px;align-items:center}
    .logo{
      width:44px;height:44px;border-radius:14px;
      background:
        radial-gradient(14px 14px at 30% 30%, rgba(255,255,255,.35), transparent 60%),
        linear-gradient(135deg, rgba(84,211,255,.95), rgba(155,123,255,.95));
      box-shadow:0 10px 25px rgba(84,211,255,.12);
      flex:none;
    }
    .title{line-height:1.1}
    .title h1{margin:0;font-size:18px;letter-spacing:.2px}
    .title .sub{margin-top:4px;font-size:12px;color:var(--muted)}
    .hdrRight{display:flex;gap:10px;align-items:center}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;border:1px solid var(--border);
      background:rgba(0,0,0,.2);
      font-size:12px;color:var(--muted);
      user-select:none;
    }
    .chip b{color:var(--text);font-weight:700}
    .btn{
      appearance:none;border:1px solid var(--border);background:rgba(255,255,255,.04);
      color:var(--text);border-radius:12px;padding:9px 12px;
      cursor:pointer;font-weight:700;font-size:13px;
      transition:.15s transform,.15s background,.15s border-color;
      touch-action:manipulation;
    }
    .btn:hover{background:rgba(255,255,255,.07);border-color:rgba(255,255,255,.16)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{
      background:linear-gradient(135deg, rgba(84,211,255,.25), rgba(155,123,255,.22));
      border-color:rgba(84,211,255,.35);
    }
    .btn.good{border-color:rgba(70,242,163,.35);background:rgba(70,242,163,.10)}
    .btn.bad{border-color:rgba(255,107,139,.35);background:rgba(255,107,139,.10)}
    .btn:disabled{opacity:.45;cursor:not-allowed;transform:none}
    .btn.mini{padding:7px 10px;border-radius:10px;font-size:12px}
    .btn.icon{display:inline-flex;align-items:center;gap:8px}
    .grid{
      margin-top:16px;
      display:grid;grid-template-columns: 1.4fr .9fr;
      gap:14px;
    }
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
    .card{
      border:1px solid var(--border);
      border-radius:var(--radius2);
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 16px;
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      border-bottom:1px solid rgba(255,255,255,.06);
      background:linear-gradient(180deg, rgba(0,0,0,.20), rgba(0,0,0,0));
    }
    .card .hd h2{margin:0;font-size:15px}
    .card .hd .hint{font-size:12px;color:var(--muted)}
    .card .bd{padding:14px 16px}
    .badge{
      display:inline-flex;align-items:center;gap:6px;
      padding:4px 8px;border-radius:999px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.18);
      font-size:12px;color:var(--muted);
      user-select:none;
    }
    .badgeNow{border-color:rgba(84,211,255,.35);color:var(--text)}
    .badgeDone{border-color:rgba(70,242,163,.35);color:var(--text)}
    .badgeSwap{border-color:rgba(255,211,122,.35);color:var(--text)}
    .mono{font-family:var(--mono)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .row.space{justify-content:space-between}
    .tabs{
      display:flex;gap:6px;flex-wrap:wrap;
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.06);
      background:rgba(0,0,0,.12);
    }
    .tabbtn{
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      color:var(--muted);
      padding:8px 10px;border-radius:12px;
      font-weight:800;font-size:12px;
      cursor:pointer;
      touch-action:manipulation;
    }
    .tabbtn.active{color:var(--text);border-color:rgba(84,211,255,.35);background:rgba(84,211,255,.10)}
    .tab{
      display:none;
      padding:14px 16px;
    }
    .tab.active{display:block}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 10px;border-bottom:1px solid rgba(255,255,255,.06);vertical-align:middle}
    th{font-size:12px;color:var(--muted);text-align:left;font-weight:800}
    td{font-size:13px}
    tr:hover td{background:rgba(255,255,255,.02)}
    .colActions{white-space:nowrap}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    .sep{height:1px;background:rgba(255,255,255,.06);margin:12px 0}
    .field{
      display:flex;flex-direction:column;gap:7px;
      padding:12px;border:1px solid rgba(255,255,255,.08);
      background:rgba(0,0,0,.18);
      border-radius:16px;
    }
    label{font-size:12px;color:var(--muted);font-weight:800}
    input,select,textarea{
      width:100%;
      border-radius:12px;border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      color:var(--text);
      padding:10px 10px;
      outline:none;
      font-size:13px;
    }
    textarea{min-height:80px;resize:vertical}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:640px){.two{grid-template-columns:1fr}}
    .note{
      padding:10px 12px;border-radius:14px;
      border:1px solid rgba(84,211,255,.20);
      background:rgba(84,211,255,.08);
      color:var(--text);
      font-size:12px;
    }
    .note.warn{border-color:rgba(255,211,122,.22);background:rgba(255,211,122,.08)}
    .note.bad{border-color:rgba(255,107,139,.22);background:rgba(255,107,139,.08)}
    .overlay{
      position:fixed;inset:0;
      background:rgba(0,0,0,.65);
      display:flex;align-items:center;justify-content:center;
      z-index:200;
      padding:18px;
    }
    .overlay.hidden{display:none !important}
    .modal{
      width:min(560px, 96vw);
      border:1px solid rgba(255,255,255,.10);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow:0 20px 70px rgba(0,0,0,.6);
      border-radius:22px;
      overflow:hidden;
    }
    .modal .mh{padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.06);display:flex;justify-content:space-between;align-items:center}
    .modal .mh h3{margin:0;font-size:15px}
    .modal .mb{padding:14px 16px}
    .modal .mf{padding:12px 16px;border-top:1px solid rgba(255,255,255,.06);display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap}
    .list{display:flex;flex-direction:column;gap:10px}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);
      font-size:12px;color:var(--muted);
      cursor:pointer;
      touch-action:manipulation;
    }
    .pill.active{border-color:rgba(70,242,163,.35);color:var(--text);background:rgba(70,242,163,.10)}
    .kpi{
      display:grid;grid-template-columns:1fr 1fr;gap:10px;
    }
    .kpi .box{
      border:1px solid rgba(255,255,255,.08);
      border-radius:16px;padding:12px;background:rgba(0,0,0,.18);
    }
    .kpi .box .t{font-size:12px;color:var(--muted);font-weight:800}
    .kpi .box .v{margin-top:6px;font-size:18px;font-weight:900}
    .footer{margin-top:14px;color:var(--muted);font-size:12px;text-align:center}
    .errbar{
      display:none;
      margin-top:12px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,107,139,.22);
      background:rgba(255,107,139,.08);
      color:var(--text);
      font-size:12px;
      line-height:1.35;
      white-space:pre-wrap;
    }
    .errbar.show{display:block}
  </style>

  <script src="https://kit.fontawesome.com/a2e0e9a0f8.js" crossorigin="anonymous"></script>
</head>

<body>
  <div class="wrap">

    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="title">
          <h1>Upratovací Plánovač <span class="mono">BD 642</span></h1>
          <div class="sub">Rozpis • Výmeny • Lokálne pripomienky • (voliteľne) Push</div>
        </div>
      </div>

      <div class="hdrRight">
        <div class="chip" id="chipUser">
          <i class="fa-solid fa-user"></i>
          <span>Rodina:</span>
          <b id="meFamilyLabel">neprihlásený</b>
        </div>

        <button class="btn primary icon" id="btnLogin" type="button">
          <i class="fa-solid fa-right-to-bracket"></i>
          Prihlásiť
        </button>

        <button class="btn bad icon" id="btnLogout" type="button" style="display:none">
          <i class="fa-solid fa-right-from-bracket"></i>
          Odhlásiť
        </button>
      </div>
    </header>

    <div id="errbar" class="errbar"></div>

    <div class="grid">

      <section class="card">
        <div class="hd">
          <div>
            <h2>Rozpis upratovania</h2>
            <div class="hint">Klikni <b>Nastaviť</b> na svojom týždni. <b>Výmena</b> otvorí žiadosť o výmenu.</div>
          </div>
          <div class="row">
            <span class="badge" id="badgeWeek"><i class="fa-regular fa-calendar"></i> Týždeň: <b id="weekNo">-</b></span>
            <span class="badge" id="badgeNow"><i class="fa-solid fa-bolt"></i> Aktuálne: <b id="nowFamily">-</b></span>
          </div>
        </div>

        <div class="tabs">
          <button class="tabbtn active" data-tab="tab-schedule" type="button"><i class="fa-solid fa-table"></i> Rozpis</button>
          <button class="tabbtn" data-tab="tab-swaps" type="button"><i class="fa-solid fa-right-left"></i> Výmeny</button>
          <button class="tabbtn" data-tab="tab-help" type="button"><i class="fa-solid fa-circle-info"></i> Pomoc</button>
        </div>

        <div class="tab active" id="tab-schedule">
          <div class="note">
            <b>Tip:</b> Ak sa ti niekedy zablokujú tlačidlá (neklikateľné), choď do <b>Nastavenia</b> a daj <b>Reset</b>.
          </div>
          <div class="sep"></div>

          <div class="kpi">
            <div class="box">
              <div class="t">Najbližší začiatok</div>
              <div class="v" id="kpiNext">-</div>
              <div class="small muted" id="kpiNextSub">-</div>
            </div>
            <div class="box">
              <div class="t">Moje nastavené pripomienky</div>
              <div class="v" id="kpiMine">0</div>
              <div class="small muted" id="kpiMineSub">-</div>
            </div>
          </div>

          <div class="sep"></div>

          <div class="row space">
            <div class="row">
              <span class="badge"><i class="fa-solid fa-location-dot"></i> Lokalita: <b>BD 642</b></span>
              <span class="badge"><i class="fa-solid fa-clock"></i> Časové pásmo: <b>Europe/Bratislava</b></span>
            </div>
            <div class="row">
              <button class="btn mini icon" id="btnToday" type="button"><i class="fa-solid fa-crosshairs"></i> Dnes</button>
              <button class="btn mini icon" id="btnExport" type="button"><i class="fa-solid fa-file-arrow-down"></i> Export</button>
            </div>
          </div>

          <div class="sep"></div>

          <div id="scheduleDesktop"></div>
          <div id="scheduleMobile" style="display:none"></div>
        </div>

        <div class="tab" id="tab-swaps">
          <div class="note warn">
            <b>Výmena:</b> Aktuálne sa používa jednoduchý režim – otvorí sa predvyplnená správa. (V ďalšej verzii sa doplní serverové schvaľovanie.)
          </div>
          <div class="sep"></div>

          <div class="field">
            <label>Predvyplnený text žiadosti o výmenu</label>
            <textarea id="swapTemplate"></textarea>
            <div class="row" style="justify-content:flex-end">
              <button class="btn mini" id="btnCopySwap" type="button"><i class="fa-regular fa-copy"></i> Kopírovať</button>
            </div>
          </div>

          <div class="sep"></div>
          <div class="small muted">
            Pozn.: V praxi si to pošlite cez skupinu / chat (WhatsApp, Messenger…). Do budúcna sa dá doplniť plný workflow cez Firebase.
          </div>
        </div>

        <div class="tab" id="tab-help">
          <div class="note">
            <b>Prihlásenie:</b> vyberieš rodinu → rozpis sa prispôsobí → na svojom týždni klikneš <b>Nastaviť</b>.
          </div>
          <div class="sep"></div>
          <div class="small">
            <ul>
              <li><b>Nastaviť</b> funguje iba pre prihlásenú rodinu na jej týždni.</li>
              <li><b>Výmena</b> otvorí žiadosť o výmenu pre konkrétny týždeň.</li>
              <li>Notifikácie v tejto HTML verzii sú <b>lokálne</b> (závisia od zariadenia a prehliadača).</li>
              <li>Push notifikácie (Firebase) sú voliteľné – rozšírenie v ďalšom kroku.</li>
            </ul>
          </div>
        </div>

      </section>

      <aside class="card">
        <div class="hd">
          <div>
            <h2>Nastavenia</h2>
            <div class="hint">Lokálne pripomienky + preferencie</div>
          </div>
          <span class="badge"><i class="fa-solid fa-gear"></i> v16</span>
        </div>

        <div class="bd">
          <div class="field">
            <label>Moja rodina (aktuálne)</label>
            <div class="row space">
              <div class="mono" id="meFamilyMono">—</div>
              <button class="btn mini" id="btnChangeFamily" type="button"><i class="fa-solid fa-pen"></i> Zmeniť</button>
            </div>
            <div class="small muted">Ak nie si prihlásený, <b>Nastaviť</b> a personalizácia sa vypnú.</div>
          </div>

          <div class="sep"></div>

          <div class="two">
            <div class="field">
              <label>Predvolený deň pripomienky</label>
              <select id="prefDay">
                <option value="monday">Pondelok</option>
                <option value="tuesday">Utorok</option>
                <option value="wednesday">Streda</option>
                <option value="thursday">Štvrtok</option>
                <option value="friday">Piatok</option>
                <option value="saturday">Sobota</option>
                <option value="sunday">Nedeľa</option>
              </select>
            </div>

            <div class="field">
              <label>Predvolený čas</label>
              <input type="time" id="prefTime" value="18:00" />
            </div>
          </div>

          <div class="sep"></div>

          <div class="field">
            <label>Pripomienky (lokálne) – pre môj týždeň</label>
            <div class="small muted">Nastaví sa pre konkrétny týždeň. Uloží sa do localStorage pre tento prehliadač.</div>
            <div id="remindersList" class="list" style="margin-top:10px"></div>

            <div class="row" style="justify-content:flex-end;margin-top:8px">
              <button class="btn mini good" id="btnEnablePush" type="button"><i class="fa-solid fa-bell"></i> Zapnúť Push</button>
              <button class="btn mini" id="simulateSync" type="button"><i class="fa-solid fa-rotate"></i> Sync</button>
              <button class="btn mini" id="resetApp" type="button" style="border-color:rgba(251,113,133,.35)"><i class="fa-solid fa-trash"></i> Reset</button>
            </div>
          </div>

          <div class="sep"></div>

          <div class="note bad" id="pushStateNote" style="display:none"></div>

          <div class="footer">BD 642 • lokálna verzia (HTML)</div>
        </div>
      </aside>
    </div>

  </div>

  <!-- LOGIN OVERLAY -->
  <div class="overlay hidden" id="loginOverlay" aria-hidden="true">
    <div class="modal">
      <div class="mh">
        <h3>Prihlásenie (výber rodiny)</h3>
        <button class="btn mini" id="closeLogin" type="button"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div class="mb">
        <div class="small muted">Vyber svoju rodinu. Uloží sa lokálne v tomto prehliadači.</div>
        <div class="sep"></div>
        <div class="list" id="familyPills"></div>

        <div class="sep"></div>
        <div class="note warn">
          <b>Poznámka:</b> Tlačidlá <b>Nastaviť</b> budú fungovať iba na týždni tvojej rodiny.
        </div>
      </div>
      <div class="mf">
        <button class="btn" id="btnDemo" type="button"><i class="fa-solid fa-eye"></i> Demo</button>
        <button class="btn primary" id="btnConfirmFamily" type="button" disabled><i class="fa-solid fa-check"></i> Potvrdiť</button>
      </div>
    </div>
  </div>

  <!-- REMINDERS OVERLAY -->
  <div class="overlay hidden" id="remOverlay" aria-hidden="true">
    <div class="modal">
      <div class="mh">
        <h3>Nastaviť pripomienky</h3>
        <button class="btn mini" id="closeRem" type="button"><i class="fa-solid fa-xmark"></i></button>
      </div>

      <div class="mb">
        <div class="note" id="remTitleNote"></div>
        <div class="sep"></div>

        <div class="two">
          <div class="field">
            <label>Deň pripomienky</label>
            <select id="remDay">
              <option value="monday">Pondelok</option>
              <option value="tuesday">Utorok</option>
              <option value="wednesday">Streda</option>
              <option value="thursday">Štvrtok</option>
              <option value="friday">Piatok</option>
              <option value="saturday">Sobota</option>
              <option value="sunday">Nedeľa</option>
            </select>
          </div>
          <div class="field">
            <label>Čas</label>
            <input type="time" id="remTime" value="18:00" />
          </div>
        </div>

        <div class="sep"></div>

        <div class="field">
          <label>Text pripomienky</label>
          <input id="remText" placeholder="Napr. Upratať schody + vchod" />
          <div class="small muted">Bude zobrazené ako lokálne upozornenie (ak to prehliadač dovolí).</div>
        </div>

        <div class="sep"></div>

        <div class="note warn small">
          Ak pripomienky nejdú, skontroluj povolenia notifikácií pre túto stránku v prehliadači.
        </div>
      </div>

      <div class="mf">
        <button class="btn bad" id="btnDeleteRem" type="button"><i class="fa-solid fa-trash"></i> Zmazať</button>
        <button class="btn" id="btnTestRem" type="button"><i class="fa-solid fa-flask"></i> Test</button>
        <button class="btn primary" id="btnSaveRem" type="button"><i class="fa-solid fa-save"></i> Uložiť</button>
      </div>
    </div>
  </div>

  <script>
    (function(){
      "use strict";

      // ====== KONFIG (lokálna) ======
      const TZ = "Europe/Bratislava";
      const families = [
        "Cuchorovci",
        "Haluškovci",
        "Jendroľovci",
        "Kikovi",
        "Kubíkovci",
        "Makuchovci",
        "Michalkovci",
        "Pavlíkovci"
      ];

      // Rozpis (pondelok - nedeľa v týždni), ukážka - uprav podľa reality:
      // Každý blok = týždeň upratovania danej rodiny
      // id: poradie, family: rodina, from/to: ISO dátum (YYYY-MM-DD)
      // Pozn.: Ak chceš "done", "swapRequested", dá sa doplniť neskôr.
      const blocks = buildScheduleFromStart("2026-01-05", 60); // generuje 60 týždňov od daného pondelka

      // ====== PERSISTENCIA ======
      const PREFS_KEY = "bd642_prefs_v16";
      const REM_KEY = "bd642_reminders_v16";        // objekt { [blockId]: {day,time,text,enabled} }
      const PRESET_KEY = "bd642_selectedFamily_v16";
      const PUSH_STATE_KEY = "bd642_push_state_v16";
      const PUSH_TOKEN_KEY = "bd642_push_token_v16";

      // ====== STATE ======
      let role = "user";         // "user" | "demo"
      let meFamily = null;       // string | null
      let pendingFamily = null;  // temp výber v login overlay
      let currentBlock = null;   // block kde je dnes (ak existuje)
      let editingBlockId = null; // pre reminders overlay

      // ====== HELPERS ======
      const $ = (q)=>document.querySelector(q);
      const $$ = (q)=>Array.from(document.querySelectorAll(q));
      const pad2 = (n)=>String(n).padStart(2,"0");
      const esc = (s)=>String(s||"").replace(/[&<>"']/g,(m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
      const showErr = (msg, err)=>{
        const box = $("#errbar");
        const line = err ? ("\n\n" + (err && err.stack ? err.stack : String(err))) : "";
        box.textContent = String(msg||"Chyba") + line;
        box.classList.add("show");
      };
      const hideErr = ()=>{ $("#errbar").classList.remove("show"); $("#errbar").textContent=""; };

      function parseISO(d){ // YYYY-MM-DD => Date
        const [y,m,dd] = String(d).split("-").map(Number);
        return new Date(Date.UTC(y, m-1, dd, 0,0,0));
      }
      function fmtDate(d){
        const dt = (d instanceof Date)? d : parseISO(d);
        const y = dt.getUTCFullYear();
        const m = pad2(dt.getUTCMonth()+1);
        const dd = pad2(dt.getUTCDate());
        return `${dd}.${m}.${y}`;
      }
      function todayUTC(){
        const now = new Date();
        return new Date(Date.UTC(now.getFullYear(), now.getMonth(), now.getDate(), 0,0,0));
      }
      function weekNumberISO(dateUTC){
        // ISO week number for a UTC date (00:00)
        const d = new Date(dateUTC.getTime());
        d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
        const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
        return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
      }

      function buildScheduleFromStart(startMondayISO, weeksCount){
        const out = [];
        const start = parseISO(startMondayISO); // pondelok
        for(let i=0;i<weeksCount;i++){
          const from = new Date(start.getTime() + i*7*86400000);
          const to = new Date(from.getTime() + 6*86400000);
          const fam = families[i % families.length];
          out.push({
            id: i+1,
            family: fam,
            from: `${from.getUTCFullYear()}-${pad2(from.getUTCMonth()+1)}-${pad2(from.getUTCDate())}`,
            to: `${to.getUTCFullYear()}-${pad2(to.getUTCMonth()+1)}-${pad2(to.getUTCDate())}`
          });
        }
        return out;
      }

      function isMobile(){
        return window.matchMedia("(max-width: 760px)").matches;
      }

      function loadPrefs(){
        try{
          const raw = localStorage.getItem(PREFS_KEY);
          return raw ? JSON.parse(raw) : { day:"thursday", time:"18:00" };
        }catch(_){
          return { day:"thursday", time:"18:00" };
        }
      }
      function savePrefs(p){
        try{ localStorage.setItem(PREFS_KEY, JSON.stringify(p)); }catch(_){}
      }
      function loadReminders(){
        try{
          const raw = localStorage.getItem(REM_KEY);
          return raw ? JSON.parse(raw) : {};
        }catch(_){
          return {};
        }
      }
      function saveReminders(obj){
        try{ localStorage.setItem(REM_KEY, JSON.stringify(obj)); }catch(_){}
      }

      function setOverlay(el, visible){
        if(!el) return;
        if(visible){
          el.classList.remove("hidden");
          el.setAttribute("aria-hidden","false");
        }else{
          el.classList.add("hidden");
          el.setAttribute("aria-hidden","true");
        }
      }

      // ====== UI RENDER ======
      function render(){
        hideErr();

        // mobile/desktop
        const mob = isMobile();
        $("#scheduleDesktop").style.display = mob ? "none" : "block";
        $("#scheduleMobile").style.display = mob ? "block" : "none";

        // chip user
        $("#meFamilyLabel").textContent = meFamily ? meFamily : "neprihlásený";
        $("#meFamilyMono").textContent = meFamily ? meFamily : "—";
        $("#btnLogout").style.display = meFamily ? "inline-flex" : "none";
        $("#btnLogin").style.display = meFamily ? "none" : "inline-flex";

        // current block
        const t = todayUTC();
        currentBlock = blocks.find(b=>{
          const from = parseISO(b.from);
          const to = parseISO(b.to);
          return t >= from && t <= to;
        }) || null;

        $("#weekNo").textContent = String(weekNumberISO(t));
        $("#nowFamily").textContent = currentBlock ? currentBlock.family : "—";

        // KPI
        const next = blocks.find(b => parseISO(b.from) >= t) || null;
        $("#kpiNext").textContent = next ? fmtDate(next.from) : "—";
        $("#kpiNextSub").textContent = next ? `${next.family} • ${fmtDate(next.from)} – ${fmtDate(next.to)}` : "—";

        const rem = loadReminders();
        let mineCnt = 0;
        let mineNext = null;

        if(meFamily){
          for(const b of blocks){
            if(b.family !== meFamily) continue;
            const r = rem[String(b.id)];
            if(r && r.enabled){
              mineCnt++;
              if(!mineNext){
                const from = parseISO(b.from);
                if(from >= t) mineNext = b;
              }
            }
          }
        }
        $("#kpiMine").textContent = String(mineCnt);
        $("#kpiMineSub").textContent = mineNext ? `Najbližšie: ${fmtDate(mineNext.from)} – ${fmtDate(mineNext.to)}` : (mineCnt? "Nastavené v minulých týždňoch" : "—");

        // schedule
        if(mob) renderScheduleMobile();
        else renderScheduleDesktop();

        // swap template
        $("#swapTemplate").value = buildSwapTemplate();
        updateRemindersPanel();
        updatePushStateUI();
      }

      function renderScheduleDesktop(){
        const rem = loadReminders();
        const t = todayUTC();
        const rows = blocks.map(b=>{
          const from = parseISO(b.from);
          const to = parseISO(b.to);
          const isNow = currentBlock && b.id===currentBlock.id;
          const hasRem = !!(rem[String(b.id)] && rem[String(b.id)].enabled);

          // DÔLEŽITÉ: Nastaviť je disabled len keď nie si prihlásený / demo.
          // Všetky ostatné podmienky rieši openReminders() (zobrazí hlášku).
          const remBtnDisabled = (role==="demo" || !meFamily) ? "disabled" : "";

          return `
            <tr>
              <td><b>${esc(b.family)}</b> ${isNow ? '<span class="badge badgeNow" style="margin-left:8px"><i class="fa-solid fa-bolt"></i> teraz</span>' : ""}</td>
              <td class="mono">${fmtDate(b.from)} – ${fmtDate(b.to)}</td>
              <td>${hasRem ? '<span class="badge badgeDone"><i class="fa-solid fa-bell"></i> nastavené</span>' : '<span class="muted">—</span>'}</td>
              <td class="colActions">
                <button type="button" class="btn mini icon" data-rem="${b.id}" ${remBtnDisabled}><i class="fa-solid fa-sliders"></i> Nastaviť</button>
                <button type="button" class="btn mini icon" data-swap="${b.id}"><i class="fa-solid fa-right-left"></i> Výmena</button>
              </td>
            </tr>
          `;
        }).join("");

        $("#scheduleDesktop").innerHTML = `
          <div style="overflow:auto;border:1px solid rgba(255,255,255,.06);border-radius:18px;background:rgba(0,0,0,.16)">
            <table>
              <thead>
                <tr>
                  <th>Rodina</th>
                  <th>Termín</th>
                  <th>Pripomienky</th>
                  <th>Akcie</th>
                </tr>
              </thead>
              <tbody>${rows}</tbody>
            </table>
          </div>
        `;
      }

      function renderScheduleMobile(){
        const rem = loadReminders();
        const cards = blocks.map(b=>{
          const isNow = currentBlock && b.id===currentBlock.id;
          const hasRem = !!(rem[String(b.id)] && rem[String(b.id)].enabled);
          const remBtnDisabled = (role==="demo" || !meFamily) ? "disabled" : "";

          return `
            <div style="border:1px solid rgba(255,255,255,.08);border-radius:18px;background:rgba(0,0,0,.16);padding:12px;margin-bottom:10px">
              <div class="row space">
                <div>
                  <b>${esc(b.family)}</b>
                  ${isNow ? ' <span class="badge badgeNow"><i class="fa-solid fa-bolt"></i> teraz</span>' : ''}
                </div>
                <div class="mono small">${fmtDate(b.from)} – ${fmtDate(b.to)}</div>
              </div>
              <div style="margin-top:8px">
                ${hasRem ? '<span class="badge badgeDone"><i class="fa-solid fa-bell"></i> nastavené</span>' : '<span class="muted small">Bez pripomienok</span>'}
              </div>
              <div class="row" style="margin-top:10px;justify-content:flex-end">
                <button type="button" class="btn mini icon" data-rem="${b.id}" ${remBtnDisabled}><i class="fa-solid fa-sliders"></i> Nastaviť</button>
                <button type="button" class="btn mini icon" data-swap="${b.id}"><i class="fa-solid fa-right-left"></i> Výmena</button>
              </div>
            </div>
          `;
        }).join("");

        $("#scheduleMobile").innerHTML = cards;
      }

      function buildSwapTemplate(blockId){
        const b = blockId ? blocks.find(x=>x.id===Number(blockId)) : currentBlock;
        const fromTo = b ? `${fmtDate(b.from)} – ${fmtDate(b.to)}` : "—";
        const fam = b ? b.family : "—";
        const me = meFamily || "___";
        return `Ahojte, prosím o výmenu týždňa.\n\nMôj týždeň: ${me}\nTýždeň na výmenu: ${fam} (${fromTo})\n\nNavrhnite, prosím, kto by vedel vymeniť. Ďakujem.`;
      }

      // ====== REMINDERS FLOW ======
      function openReminders(blockId){
        const b = blocks.find(x=>x.id===Number(blockId));
        if(!b || !meFamily || role==="demo") return;

        if (b.family !== meFamily) {
          alert("Upozornenia vieš nastaviť iba pre svoj týždeň (podľa prihlásenej rodiny).");
          return;
        }

        editingBlockId = b.id;
        const prefs = loadPrefs();
        const rem = loadReminders();
        const cur = rem[String(b.id)] || { day:prefs.day, time:prefs.time, text:`Upratovanie: ${b.family}`, enabled:true };

        $("#remTitleNote").innerHTML = `<b>${esc(b.family)}</b> • ${fmtDate(b.from)} – ${fmtDate(b.to)}`;
        $("#remDay").value = cur.day || prefs.day;
        $("#remTime").value = cur.time || prefs.time;
        $("#remText").value = cur.text || `Upratovanie: ${b.family}`;

        setOverlay($("#remOverlay"), true);
      }

      function updateRemindersPanel(){
        const prefs = loadPrefs();
        $("#prefDay").value = prefs.day || "thursday";
        $("#prefTime").value = prefs.time || "18:00";

        const rem = loadReminders();
        const list = $("#remindersList");
        list.innerHTML = "";

        if(!meFamily){
          list.innerHTML = `<div class="note warn">Najprv sa prihlás (vyber rodinu), aby sa dali spravovať pripomienky.</div>`;
          return;
        }

        // ukáž iba pripomienky pre rodinu (v jej týždňoch)
        const mine = blocks.filter(b=>b.family===meFamily).map(b=>{
          const r = rem[String(b.id)];
          if(!r || !r.enabled) return null;
          return { b, r };
        }).filter(Boolean);

        if(!mine.length){
          list.innerHTML = `<div class="small muted">Zatiaľ nemáš nastavené pripomienky. Klikni <b>Nastaviť</b> na svojom týždni v rozpis-e.</div>`;
          return;
        }

        for(const it of mine){
          const b = it.b, r = it.r;
          const el = document.createElement("div");
          el.className = "field";
          el.innerHTML = `
            <div class="row space">
              <div><b>${esc(b.family)}</b> <span class="muted small">(${fmtDate(b.from)} – ${fmtDate(b.to)})</span></div>
              <button class="btn mini" type="button" data-rem="${b.id}"><i class="fa-solid fa-sliders"></i> Upraviť</button>
            </div>
            <div class="small"><b>${esc(r.day)}</b> • <span class="mono">${esc(r.time)}</span> • ${esc(r.text)}</div>
          `;
          list.appendChild(el);
        }
      }

      function saveReminderFromModal(){
        const b = blocks.find(x=>x.id===Number(editingBlockId));
        if(!b || !meFamily || role==="demo") return;

        const day = $("#remDay").value;
        const time = $("#remTime").value;
        const text = ($("#remText").value || "").trim() || `Upratovanie: ${b.family}`;

        const rem = loadReminders();
        rem[String(b.id)] = { day, time, text, enabled:true };
        saveReminders(rem);

        // Po uložení naplánuj lokálnu notifikáciu (iba best-effort)
        scheduleLocalReminder(b, rem[String(b.id)]);

        setOverlay($("#remOverlay"), false);
        render();
      }

      function deleteReminderFromModal(){
        const b = blocks.find(x=>x.id===Number(editingBlockId));
        if(!b) return;
        const rem = loadReminders();
        delete rem[String(b.id)];
        saveReminders(rem);
        setOverlay($("#remOverlay"), false);
        render();
      }

      function testReminderFromModal(){
        const text = ($("#remText").value || "").trim() || "Test notifikácie";
        fireLocalNotification("BD 642 – Test", text);
      }

      // ====== LOCAL NOTIFICATIONS (best-effort) ======
      async function ensureNotificationPermission(){
        try{
          if(!("Notification" in window)) return false;
          if(Notification.permission === "granted") return true;
          if(Notification.permission === "denied") return false;
          const perm = await Notification.requestPermission();
          return perm === "granted";
        }catch(_){
          return false;
        }
      }

      function fireLocalNotification(title, body){
        try{
          if(!("Notification" in window)) return;
          if(Notification.permission !== "granted") return;
          new Notification(title, { body });
        }catch(_){}
      }

      function getDateForWeekdayInBlock(block, weekday){
        // weekday: monday..sunday => dátum v rozsahu block
        const map = { monday:1, tuesday:2, wednesday:3, thursday:4, friday:5, saturday:6, sunday:7 };
        const want = map[weekday] || 4;

        const from = parseISO(block.from);
        const fromDow = (from.getUTCDay()===0 ? 7 : from.getUTCDay()); // 1..7
        const delta = want - fromDow;
        const d = new Date(from.getTime() + delta*86400000);
        return d;
      }

      function scheduleLocalReminder(block, rem){
        // Naplánuj iba ak je to budúci čas (najbližšie)
        try{
          const dayDate = getDateForWeekdayInBlock(block, rem.day);
          const [hh,mm] = String(rem.time||"18:00").split(":").map(Number);
          const when = new Date(Date.UTC(dayDate.getUTCFullYear(), dayDate.getUTCMonth(), dayDate.getUTCDate(), hh||18, mm||0, 0));
          const now = new Date();
          const ms = when.getTime() - now.getTime();
          if(ms <= 2000 || ms > 7*86400000) return; // mimo rozumného okna (best-effort)
          setTimeout(async ()=>{
            const ok = await ensureNotificationPermission();
            if(ok){
              fireLocalNotification("BD 642 – Pripomienka", rem.text || "Upratovanie");
            }
          }, ms);
        }catch(_){}
      }

      // ====== LOGIN / LOGOUT ======
      function openLogin(){
        pendingFamily = null;
        $("#btnConfirmFamily").disabled = true;
        buildFamilyPills();
        setOverlay($("#loginOverlay"), true);
      }

      function buildFamilyPills(){
        const box = $("#familyPills");
        box.innerHTML = "";
        for(const fam of families){
          const pill = document.createElement("button");
          pill.type = "button";
          pill.className = "pill";
          pill.textContent = fam;
          pill.addEventListener("click", ()=>{
            $$("#familyPills .pill").forEach(p=>p.classList.remove("active"));
            pill.classList.add("active");
            pendingFamily = fam;
            $("#btnConfirmFamily").disabled = false;
          });
          box.appendChild(pill);
        }
      }

      function confirmFamily(){
        if(!pendingFamily) return;
        role = "user";
        meFamily = pendingFamily;
        try{
          localStorage.setItem(PRESET_KEY, meFamily);
          localStorage.setItem("bd642_meFamily", meFamily);
          localStorage.removeItem("bd642_role"); // zruš demo flag
        }catch(_){}
        setOverlay($("#loginOverlay"), false);
        render();
      }

      function demoMode(){
        // Demo je povolené iba cez URL ?demo=1
        const urlDemo = (() => {
          try { return new URLSearchParams(location.search).get("demo") === "1"; }
          catch(_) { return false; }
        })();

        if(!urlDemo){
          alert("Demo režim sa zapína iba cez URL parameter ?demo=1");
          return;
        }

        role = "demo";
        meFamily = null;
        try{
          localStorage.setItem("bd642_role","demo");
          localStorage.removeItem(PRESET_KEY);
          localStorage.removeItem("bd642_meFamily");
        }catch(_){}
        setOverlay($("#loginOverlay"), false);
        render();
      }

      function doLogout(){
        role = "user";
        meFamily = null;
        try{
          localStorage.removeItem(PRESET_KEY);
          localStorage.removeItem("bd642_meFamily");
          localStorage.removeItem("bd642_role");
        }catch(_){}
        render();
        // zobraziť login overlay po logout
        setOverlay($("#loginOverlay"), true);
      }

      // ====== TABS ======
      function showTab(id){
        $$(".tabbtn").forEach(b=>b.classList.toggle("active", b.dataset.tab===id));
        $$(".tab").forEach(t=>t.classList.toggle("active", t.id===id));
      }

      // ====== EXPORT ======
      function doExport(){
        const data = {
          version: "v16",
          tz: TZ,
          meFamily,
          prefs: loadPrefs(),
          reminders: loadReminders(),
          generatedAt: new Date().toISOString(),
          schedule: blocks
        };
        const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `bd642_export_${Date.now()}.json`;
        document.body.appendChild(a);
        a.click();
        setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 2000);
      }

      // ====== PUSH (voliteľné) ======
      function updatePushStateUI(){
        // len UI; reálne push rieši externý skript, ak je napojený
        let state = null;
        try{ state = JSON.parse(localStorage.getItem(PUSH_STATE_KEY) || "null"); }catch(_){}
        const note = $("#pushStateNote");
        if(!state){
          note.style.display = "none";
          return;
        }
        note.style.display = "block";
        note.textContent = state.message || "Push stav: neznámy";
      }

      async function enablePushFromButton(){
        // Tento hook je pripravený na tvoju existujúcu logiku (bd642_firebase_messaging.js)
        // Musí existovať globálna funkcia: window.BD642_EnablePush()
        try{
          if(typeof window.BD642_EnablePush !== "function"){
            alert("Push modul nie je pripojený (BD642_EnablePush chýba). Najprv doplň bd642_firebase_messaging.js.");
            return;
          }
          const res = await window.BD642_EnablePush();
          try{ localStorage.setItem(PUSH_STATE_KEY, JSON.stringify({ ok:true, message: String(res||"Push zapnutý") })); }catch(_){}
          updatePushStateUI();
        }catch(err){
          try{ localStorage.setItem(PUSH_STATE_KEY, JSON.stringify({ ok:false, message: "Push chyba: " + String(err && err.message ? err.message : err) })); }catch(_){}
          updatePushStateUI();
        }
      }

      function syncAllServerPush(){
        // placeholder - v tvojej verzii sa tu môže volať fetch na server, ak existuje
        // teraz iba refresh UI
        render();
      }

      // ====== WIRE EVENTS ======
      function wire(){
        // tabs
        $$(".tabbtn").forEach(btn=>{
          btn.addEventListener("click", ()=>showTab(btn.dataset.tab));
        });

        // login/logout
        $("#btnLogin").addEventListener("click", openLogin);
        $("#btnChangeFamily").addEventListener("click", openLogin);
        $("#btnLogout").addEventListener("click", doLogout);

        $("#closeLogin").addEventListener("click", ()=>setOverlay($("#loginOverlay"), false));
        $("#btnConfirmFamily").addEventListener("click", confirmFamily);
        $("#btnDemo").addEventListener("click", demoMode);

        // reminders modal
        $("#closeRem").addEventListener("click", ()=>setOverlay($("#remOverlay"), false));
        $("#btnSaveRem").addEventListener("click", saveReminderFromModal);
        $("#btnDeleteRem").addEventListener("click", deleteReminderFromModal);
        $("#btnTestRem").addEventListener("click", testReminderFromModal);

        // prefs
        $("#prefDay").addEventListener("change", ()=>{
          const p = loadPrefs();
          p.day = $("#prefDay").value;
          savePrefs(p);
        });
        $("#prefTime").addEventListener("change", ()=>{
          const p = loadPrefs();
          p.time = $("#prefTime").value;
          savePrefs(p);
        });

        // export
        $("#btnExport").addEventListener("click", doExport);

        // today (scroll na aktuálny blok v tabuľke)
        $("#btnToday").addEventListener("click", ()=>{
          showTab("tab-schedule");
          // v mobile nič netreba; v desktop-e posuň sa približne na "teraz"
          try{
            const b = currentBlock;
            if(!b) return;
            const btn = document.querySelector(`[data-rem="${b.id}"]`);
            if(btn) btn.scrollIntoView({behavior:"smooth", block:"center"});
          }catch(_){}
        });

        // swap copy
        $("#btnCopySwap").addEventListener("click", async ()=>{
          try{
            await navigator.clipboard.writeText($("#swapTemplate").value);
            $("#btnCopySwap").textContent = "Skopírované";
            setTimeout(()=>$("#btnCopySwap").innerHTML = '<i class="fa-regular fa-copy"></i> Kopírovať', 1200);
          }catch(_){
            alert("Nepodarilo sa skopírovať do schránky.");
          }
        });

        // PUSH + SYNC + RESET
        $("#btnEnablePush").addEventListener("click", enablePushFromButton);
        $("#simulateSync").addEventListener("click", ()=>{ try{ syncAllServerPush(); }catch(_){ render(); } });

        $("#resetApp").addEventListener("click", ()=>{
          if(!confirm("Reset vymaže lokálne nastavenia (kód rodiny, preferencie, upozornenia). Pokračovať?")) return;
          try{
            localStorage.removeItem("bd642_meFamily");
            localStorage.removeItem("bd642_role");
            localStorage.removeItem(PREFS_KEY);
            localStorage.removeItem(REM_KEY);
            localStorage.removeItem(PRESET_KEY);
            localStorage.removeItem(PUSH_STATE_KEY);
            localStorage.removeItem(PUSH_TOKEN_KEY);
          }catch(_){}
          location.reload();
        });

        // Delegácia klikov na Nastaviť / Výmena (robustne)
        document.addEventListener("click", (ev)=>{
          const t = ev.target;
          if(!t) return;

          const remBtn = t.closest && t.closest("[data-rem]");
          if(remBtn){
            const id = remBtn.getAttribute("data-rem");
            // Ak je disabled, nič
            if(remBtn.hasAttribute("disabled")) return;
            openReminders(id);
            return;
          }

          const swapBtn = t.closest && t.closest("[data-swap]");
          if(swapBtn){
            const id = swapBtn.getAttribute("data-swap");
            $("#swapTemplate").value = buildSwapTemplate(id);
            showTab("tab-swaps");
            return;
          }
        }, {capture:false});

        // resize rerender
        window.addEventListener("resize", ()=>render());
      }

      // ====== INIT (s automatickou opravou zaseknutého demo režimu) ======
      function init(){
        // 1) načítaj uloženú rodinu + demo flag
        const savedFam = (localStorage.getItem("bd642_meFamily") || localStorage.getItem(PRESET_KEY) || "").trim();
        const savedRole = (localStorage.getItem("bd642_role") || "").trim();

        // Demo režim povoľ iba cez URL ?demo=1
        const urlDemo = (() => {
          try { return new URLSearchParams(location.search).get("demo") === "1"; }
          catch(_) { return false; }
        })();

        // Ak bol demo režim uložený omylom, automaticky ho zruš (inak budú tlačidlá disabled)
        if (savedRole === "demo" && !urlDemo) {
          try { localStorage.removeItem("bd642_role"); } catch(_) {}
        }

        const effectiveRole = (savedRole === "demo" && urlDemo) ? "demo" : "user";

        if (effectiveRole === "demo") {
          role = "demo";
          meFamily = null;
          setOverlay($("#loginOverlay"), false);
        } else if (savedFam && families.includes(savedFam)) {
          role = "user";
          meFamily = savedFam;
          setOverlay($("#loginOverlay"), false);

          // voliteľné hooky
          setTimeout(()=>{ try{ window.dispatchEvent(new Event("BD642:PoPrihlaseni")); }catch(_){ } }, 300);
          setTimeout(()=>{ try{ syncAllServerPush(); }catch(_){ } }, 800);
        } else {
          role = "user";
          meFamily = null;
          // zobraziť login pri prvom spustení
          setOverlay($("#loginOverlay"), true);
        }

        // 2) prefs default
        const p = loadPrefs();
        if(!p || !p.day || !p.time){
          savePrefs({ day:"thursday", time:"18:00" });
        }

        // 3) wire + render
        wire();
        render();
      }

      try{
        init();
      }catch(err){
        showErr("Inicializácia zlyhala. Pozri chybu nižšie.", err);
      }

    })();
  </script>

  <!-- Voliteľné: tvoj existujúci modul pre Firebase Messaging -->
  <!-- <script src="./bd642_firebase_messaging.js"></script> -->
</body>
</html>